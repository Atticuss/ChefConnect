AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Description: ChefConnect API

Parameters:
  Environment:
    Type: String
    AllowedValues: [prod, dev]
    Default: dev
    Description: Target deployment environment. Defaults to "dev".
  DgraphHost:
    Type: String
  DgraphPort:
    Type: String
  DgraphAuthToken:
    Type: String
  JwtSecretKey:
    Type: String

Mappings:
  EnvMap:
    dev:
      apiDomain: api.dev.recipes.veraciousdata.io
      staticDomain: dev.recipes.veraciousdata.io
      staticBucketName: chefconnect-static-dev
    prod:
      apiDomain: api.recipes.veraciousdata.io
      staticDomain: recipes.veraciousdata.io
      staticBucketName: chefconnect-static-prod 

# CFN can't handle tearing down ENIs associated with VPC-deployed Lambdas. recommended
# solution is to create VPC resource in a separate CF stack. to address this, split up
# the CFN templates for VPC infra and API GW/Lambda code resources.
# ref: https://github.com/serverless/serverless/issues/5008
Resources:
  #InfraDeployment:
  #  Type: AWS::Serverless::Application
  #  Properties:
  #    Location: infra.yaml
  CodeDeployment:
    Type: AWS::Serverless::Application
    Properties:
      Location: code.yaml
      Parameters:
        Environment: !Ref Environment
        DgraphAuthToken: !Ref DgraphAuthToken
        DgraphHost: !Ref DgraphHost
        DgraphPort: !Ref DgraphPort
        Domain: !FindInMap [EnvMap, !Ref Environment, apiDomain]
        JwtSecretKey: !Ref JwtSecretKey
        #SecurityGroup:
        #  Fn::GetAtt: [InfraDeployment, Outputs.LambdaSecurityGroup]
        #SubnetIdList:
        #  Fn::GetAtt: [InfraDeployment, Outputs.PrivateSubnetIdList]
  FrontendDeployment:
    Type: AWS::Serverless::Application
    Properties:
      Location: frontend.yaml
      Parameters:
        Environment: !Ref Environment
        Domain: !FindInMap [EnvMap, !Ref Environment, staticDomain]
        BucketName: !FindInMap [EnvMap, !Ref Environment, staticBucketName]

Outputs:
  ApiDomain:
    Value: !FindInMap [EnvMap, !Ref Environment, apiDomain]
  StaticDomain:
    Value: !FindInMap [EnvMap, !Ref Environment, staticDomain]
  StaticBucket:
    Value: !FindInMap [EnvMap, !Ref Environment, staticBucketName]